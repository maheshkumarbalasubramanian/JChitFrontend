<div class="loan-create-container">
  <div class="header">
    <div class="title-section">
      <button type="button" class="back-btn" (click)="goBack()">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1>{{ isEditMode ? 'Edit' : 'New' }} Loan <span class="sub-title">({{ isEditMode ? 'Update' : 'Create New' }})</span></h1>
    </div>
    <div class="header-actions">
      <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" placeholder="Type here to Search">
      </div>
      <button class="btn btn-outline" (click)="showActions = !showActions">
        <i class="fa fa-ellipsis-v"></i> Actions
      </button>
      <div class="loan-status">
        <span class="status-label">Loan Status</span>
        <span class="status-badge open">Open</span>
      </div>
    </div>
  </div>

  <form [formGroup]="loanForm" (ngSubmit)="onSubmit()" class="loan-form">
    <!-- Basic Information Section -->
    <div class="form-section basic-info">
      <div class="form-row">
        <div class="form-group">
          <label for="series">Series</label>
          <select id="series" class="form-control" formControlName="series">
            <option value="GOLD SERIES">GOLD SERIES</option>
            <option value="SILVER SERIES">SILVER SERIES</option>
            <option value="DIAMOND SERIES">DIAMOND SERIES</option>
          </select>
          <i class="fa fa-check success-icon" *ngIf="loanForm.get('series')?.valid"></i>
        </div>

        <div class="form-group">
          <label for="refNumber">Ref Number</label>
          <input type="text" id="refNumber" class="form-control" formControlName="refNumber">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="loanNumber">Loan Number</label>
          <input type="text" id="loanNumber" class="form-control" formControlName="loanNumber" readonly>
        </div>

        <div class="form-group">
          <label for="loanDate">Loan Date</label>
          <input type="date" id="loanDate" class="form-control" formControlName="loanDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="areaId">Area <span class="required">*</span></label>
          <select id="areaId" class="form-control" formControlName="areaId" (change)="onAreaChange()">
            <option value="">Select Area</option>
            <option *ngFor="let area of areas" [value]="area.id">
              {{ area.areaCode }} - {{ area.areaName }}
            </option>
          </select>
          <i class="fa fa-check success-icon" *ngIf="loanForm.get('areaId')?.valid"></i>
        </div>

        <div class="form-group">
          <label for="customer">Customer <span class="required">*</span></label>
          <div class="customer-input">
            <input type="text" 
                   id="customer" 
                   class="form-control" 
                   formControlName="customerSearch" 
                   placeholder="Search customer..." 
                   (input)="searchCustomers($event)">
            <button type="button" 
                    class="customer-dropdown-btn" 
                    (click)="toggleCustomerDropdown()">
              <i class="fa fa-chevron-down"></i>
            </button>
          </div>
          <div class="dropdown-list" *ngIf="showCustomerDropdown && filteredCustomers.length > 0">
            <div *ngFor="let customer of filteredCustomers" 
                 class="dropdown-item" 
                 (click)="selectCustomer(customer)">
              <span class="customer-name">{{ customer.customerName }}</span>
              <span class="customer-code">{{ customer.relationName }} - {{ customer.relationshipName }}</span>
              <span class="customer-code">{{ customer.address1 }} </span>
              <span class="customer-code">{{ customer.mobile }} </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Photo Section - Enhanced UI -->
    <div class="form-section customer-photo-section" *ngIf="loanForm.get('customerId')?.value">
      <h3><i class="fa fa-user-circle"></i> Customer Photo</h3>
      <div class="photo-upload-container">
        <!-- Image Preview or Placeholder -->
        <div class="photo-preview-box">
          <div class="photo-preview" *ngIf="customerImage">
            <img [src]="customerImage" alt="Customer Photo">
          </div>
          <div class="photo-placeholder" *ngIf="!customerImage">
            <i class="fa fa-camera"></i>
            <p>No photo uploaded</p>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="photo-actions">
          <!-- Hidden file inputs -->
          <input type="file" 
                 id="customerImageBrowse" 
                 class="file-input-hidden"
                 accept="image/*"
                 (change)="onCustomerImageSelected($event)">
          
          <input type="file" 
                 id="customerImageInput" 
                 class="file-input-hidden"
                 accept="image/*"
                 capture="user"
                 (change)="onCustomerImageSelected($event)">
          
          <!-- Visible Buttons -->
          <button type="button" class="btn-photo btn-browse" (click)="browseCustomerImage()">
            <i class="fa fa-folder-open"></i> Browse
          </button>
          
          <button type="button" class="btn-photo btn-capture" (click)="captureCustomerImage()">
            <i class="fa fa-camera"></i> Capture
          </button>
          
          <button type="button" 
                  class="btn-photo btn-remove" 
                  (click)="removeCustomerImage()"
                  *ngIf="customerImage">
            <i class="fa fa-trash"></i> Remove
          </button>
        </div>
      </div>
    </div>

    <!-- Customer History Section -->
    <div class="customer-history-section" *ngIf="selectedCustomerHistory">
      <div class="customer-profile">
        <div class="profile-left">
          <div class="customer-avatar" *ngIf="profileImageUrl">
            <img [src]="profileImageUrl" alt="Customer">
          </div>
          <div class="customer-avatar-placeholder" *ngIf="!profileImageUrl">
            <i class="fa fa-user"></i>
          </div>
          <div class="customer-details">
            <h4>{{ selectedCustomerHistory.customerName }}</h4>
            <h3>{{ selectedCustomerHistory.relationName }} - {{ selectedCustomerHistory.relationshipName }}</h3>
            <p class="customer-code">Code: {{ selectedCustomerHistory.customerCode }}</p>
            <p> {{ selectedCustomerHistory.address }}</p>:
            <p>Ph: {{ selectedCustomerHistory.mobile }}</p>
          </div>
        </div>
        
        <div class="loan-status-summary">
          <div class="status-item live">
            <div class="status-label">Live</div>
            <div class="status-count">{{ selectedCustomerHistory.loanCounts.live }}</div>
          </div>
          <div class="status-item closed">
            <div class="status-label">Closed</div>
            <div class="status-count">{{ selectedCustomerHistory.loanCounts.closed }}</div>
          </div>
          <div class="status-item matured">
            <div class="status-label">Matured</div>
            <div class="status-count">{{ selectedCustomerHistory.loanCounts.matured }}</div>
          </div>
          <div class="status-item auctioned">
            <div class="status-label">Auctioned</div>
            <div class="status-count">{{ selectedCustomerHistory.loanCounts.auctioned }}</div>
          </div>
        </div>
      </div>

      <div class="loan-history-table" *ngIf="selectedCustomerHistory.loans.length > 0">
        <div class="table-header">
          <div class="col">#</div>
          <div class="col">Loan No</div>
          <div class="col">Loan Date</div>
          <div class="col">Principal</div>
          <div class="col">Net Wt</div>
          <div class="col">Duration</div>
          <div class="col">Status</div>
        </div>
        <div class="table-body">
          <div *ngFor="let loan of selectedCustomerHistory.loans; let i = index" class="table-row">
            <div class="col">{{ i + 1 }}</div>
            <div class="col loan-no">{{ loan.loanNumber }}</div>
            <div class="col">{{ loan.loanDate | date:'dd/MM/yyyy' }}</div>
            <div class="col principal">₹{{ loan.loanAmount | number:'1.0-0' }}</div>
            <div class="col net-weight">{{ loan.totalNetWeight }} gm</div>
            <div class="col">{{ loan.duration }}</div>
            <div class="col">
              <span class="status-badge" [ngClass]="loan.status.toLowerCase()">
                {{ loan.status }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Item Group and Scheme Selection -->
    <div class="form-section basic-info-bottom">
      <div class="form-row">
        <div class="form-group">
          <label for="itemGroup">Item Group <span class="required">*</span></label>
          <select id="itemGroup" class="form-control" formControlName="itemGroupId" (change)="onItemGroupChange()"
                  [disabled]="!loanForm.get('areaId')?.value">
            <option value="">Select Item Group</option>
            <option *ngFor="let group of itemGroups" [value]="group.id">{{ group.groupName }}</option>
          </select>
          <i class="fa fa-check success-icon" *ngIf="loanForm.get('itemGroupId')?.valid"></i>
        </div>

        <div class="form-group">
          <label for="scheme">Scheme <span class="required">*</span></label>
          <select id="scheme" class="form-control" formControlName="schemeId" (change)="onSchemeChange()"
                  [disabled]="!loanForm.get('itemGroupId')?.value">
            <option value="">Select Scheme</option>
            <option *ngFor="let scheme of schemes" [value]="scheme.id">{{ scheme.schemeName }}</option>
          </select>
          <i class="fa fa-check success-icon" *ngIf="loanForm.get('schemeId')?.valid"></i>
        </div>
      </div>
    </div>

    <!-- Enhanced Pledged Items Section -->
    <div class="form-section pledged-items-section">
      <div class="section-header">
        <h3>Pledged Items Details</h3>
        <button type="button" class="btn btn-primary" (click)="addItem()"
                [disabled]="!loanForm.get('itemGroupId')?.value">
          <i class="fa fa-plus"></i> Add Item
        </button>
      </div>

      <div class="items-container" formArrayName="pledgedItems">
        <div *ngFor="let item of pledgedItemsArray.controls; let i = index" 
             [formGroupName]="i" 
             class="item-card">
          
          <!-- Item Header -->
          <div class="item-header">
            <span class="item-number">Item {{ i + 1 }}</span>
            <button type="button" class="btn-remove" (click)="removeItem(i)" *ngIf="pledgedItemsArray.length > 1">
              <i class="fa fa-trash"></i> Remove
            </button>
          </div>

          <!-- Row 1: Item Type, Item Name, Purity -->
          <div class="form-row">
            <div class="form-group">
              <label for="itemType_{{i}}">Item Type <span class="required">*</span></label>
              <select [id]="'itemType_' + i" class="form-control" formControlName="itemTypeId" 
                      (change)="onItemTypeChange(i)">
                <option value="">Select Item Type</option>
                <option *ngFor="let type of itemTypes" [value]="type.id">
                  {{ type.itemName }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="itemName_{{i}}">Item Name <span class="required">*</span></label>
              <input type="text" [id]="'itemName_' + i" class="form-control" 
                     formControlName="itemName"
                     placeholder="Enter item name">
            </div>

            <div class="form-group">
              <label for="purity_{{i}}">Gold Purity <span class="required">*</span></label>
              <select [id]="'purity_' + i" class="form-control" formControlName="purityId" 
                      (change)="onPurityChange(i)">
                <option value="">Select Purity</option>
                <option *ngFor="let rate of purities" [value]="rate.id">
                  {{ rate.purityName }} - {{ rate.purityPercentage }}% Purity
                </option> 
              </select>
            </div>
          </div>

          <!-- Row 2: Quantities and Weights -->
          <div class="form-row">
            <div class="form-group">
              <label for="qty_{{i}}">Quantity <span class="required">*</span></label>
              <input type="number" [id]="'qty_' + i" class="form-control" 
                     formControlName="qty" min="1" step="1"
                     placeholder="Enter quantity"
                     (input)="calculateItemValue(i)">
            </div>

            <div class="form-group">
              <label for="grossWeight_{{i}}">Gross Weight (gm) <span class="required">*</span></label>
              <input type="number" [id]="'grossWeight_' + i" class="form-control" 
                     formControlName="grossWeight" min="0.01" step="0.01"
                     placeholder="0.00"
                     (input)="onWeightChange(i)">
            </div>

            <div class="form-group stone-weight-highlight">
              <label for="stoneWeight_{{i}}">
                <i class="fa fa-gem"></i> Stone Weight (gm)
              </label>
              <input type="number" [id]="'stoneWeight_' + i" class="form-control" 
                     formControlName="stoneWeight" min="0" step="0.01"
                     placeholder="0.00"
                     (input)="onWeightChange(i)">
              <small class="form-text"><i class="fa fa-minus-circle"></i> Deducted from gross</small>
            </div>

            <div class="form-group">
              <label for="netWeight_{{i}}">Net Weight (gm) <span class="required">*</span></label>
              <input type="number" [id]="'netWeight_' + i" class="form-control" 
                     formControlName="netWeight" min="0.01" step="0.01" readonly>
              <small class="form-text">After deductions</small>
            </div>

            <div class="form-group">
              <label for="goldRate_{{i}}">Gold Rate (₹/gm)</label>
              <input type="number" [id]="'goldRate_' + i" class="form-control" 
                     formControlName="goldRate" readonly>
            </div>
          </div>

          <!-- Row 3: Values -->
          <div class="form-row">
            <div class="form-group">
              <label for="calculatedValue_{{i}}">Calculated Value (₹)</label>
              <input type="number" [id]="'calculatedValue_' + i" class="form-control" 
                     formControlName="calculatedValue" readonly>
              <small class="form-text">Auto-calculated</small>
            </div>

            <div class="form-group">
              <label for="maximumValue_{{i}}">Maximum Value (₹) <span class="required">*</span></label>
              <input type="number" [id]="'maximumValue_' + i" class="form-control" 
                     formControlName="maximumValue" min="1" step="1"
                     placeholder="Enter maximum value"
                     (input)="calculateTotals()">
            </div>

            <div class="form-group">
              <label for="jewelFault_{{i}}">Jewel Fault</label>
              <select [id]="'jewelFault_' + i" class="form-control" formControlName="jewelFault">
                <option value="">No fault</option>
                <option *ngFor="let fault of faults" [value]="fault.id">
                  {{ fault.faultName }}
                </option> 
              </select>
            </div>
          </div>

          <!-- Row 4: Remarks -->
          <div class="form-row">
            <div class="form-group full-width">
              <label for="remarks_{{i}}">Remarks</label>
              <textarea [id]="'remarks_' + i" class="form-control" 
                        formControlName="remarks" rows="2"
                        placeholder="Additional notes..."></textarea>
            </div>
          </div>

          <!-- Row 5: Item Photos - Enhanced UI -->
          <div class="item-photos-section">
            <h4><i class="fa fa-images"></i> Item Photos</h4>
            
            <div class="photo-upload-grid">
              <!-- Photo Preview or Placeholder -->
              <div class="photo-preview-box">
                <div class="photos-grid" *ngIf="getImageArray(item.get('images')?.value).length > 0">
                  <div *ngFor="let image of getImageArray(item.get('images')?.value); let imgIndex = index" 
                       class="photo-thumbnail">
                    <img [src]="image" alt="Item photo">
                    <button type="button" class="remove-photo-btn" (click)="removeImage(i, imgIndex)">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="photo-placeholder" *ngIf="getImageArray(item.get('images')?.value).length === 0">
                  <i class="fa fa-camera"></i>
                  <p>No photos uploaded</p>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="photo-actions">
                <!-- Hidden file inputs -->
                <input type="file" 
                       [id]="'itemImageBrowse_' + i" 
                       class="file-input-hidden"
                       accept="image/*"
                       multiple
                       (change)="onFileSelected($event, i)">
                
                <input type="file" 
                       [id]="'itemImageCapture_' + i" 
                       class="file-input-hidden"
                       accept="image/*"
                       capture="environment"
                       multiple
                       (change)="onFileSelected($event, i)">
                
                <!-- Visible Buttons -->
                <button type="button" class="btn-photo btn-browse" (click)="browseItemImage(i)">
                  <i class="fa fa-folder-open"></i> Browse
                </button>
                
                <div class="profile-image" [class.has-image]="profileImagePreview">
                  <img *ngIf="profileImagePreview" [src]="profileImagePreview" alt="Profile" class="profile-img">
                  <i *ngIf="!profileImagePreview" class="fa fa-camera"></i>
                </div>

                <button type="button" class="btn-photo btn-capture" (click)="captureItemImage(i)">
                  <i class="fa fa-camera"></i> Capture
                </button>
                
                <small class="photo-count" *ngIf="getImageArray(item.get('images')?.value).length > 0">
                  <i class="fa fa-check-circle"></i> {{ getImageArray(item.get('images')?.value).length }} photo(s) uploaded
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Items Summary -->
      <div class="items-summary">
        <h4>Summary</h4>
        <div class="summary-row">
          <div class="summary-item">
            <label>Total Items:</label>
            <span class="value">{{ totalQty }}</span>
          </div>
          <div class="summary-item">
            <label>Gross Weight:</label>
            <span class="value">{{ totalGrossWeight | number:'1.3-3' }} gm</span>
          </div>
          <div class="summary-item stone-highlight">
            <label><i class="fa fa-gem"></i> Stone Weight:</label>
            <span class="value">{{ totalStoneWeight | number:'1.3-3' }} gm</span>
          </div>
          <div class="summary-item">
            <label>Net Weight:</label>
            <span class="value">{{ totalNetWeight | number:'1.3-3' }} gm</span>
          </div>
          <div class="summary-item">
            <label>Calculated Value:</label>
            <span class="value">₹{{ totalCalculatedValue | number:'1.0-0' }}</span>
          </div>
          <div class="summary-item">
            <label>Maximum Value:</label>
            <span class="value primary">₹{{ totalMaximumValue | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Loan Amount Entry -->
    <div class="form-section manual-loan-section" *ngIf="selectedScheme && totalMaximumValue > 0">
      <h3>Desired Loan Amount</h3>
      <div class="manual-loan-container">
        <div class="form-row">
          <div class="form-group loan-amount-group">
            <label for="manualLoanAmount">Enter Loan Amount (₹) <span class="required">*</span></label>
            <input type="number" 
                   id="manualLoanAmount" 
                   class="form-control loan-amount-input" 
                   formControlName="manualLoanAmount" 
                   [max]="maxLoanAmount"
                   min="0" 
                   step="100"
                   placeholder="Enter desired loan amount">
            <small class="form-text max-loan-info">
              <i class="fa fa-info-circle"></i> Maximum: <strong>₹{{ maxLoanAmount | number:'1.0-0' }}</strong>
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Loan Calculation Section -->
    <div class="form-section loan-calculation-section" *ngIf="selectedScheme">
      <h3>Loan Calculation Details</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label for="dueMonths">Due Months <span class="required">*</span></label>
          <input type="number" id="dueMonths" class="form-control" 
                 formControlName="dueMonths" min="1" max="60" step="1"
                 (input)="calculateLoanAmounts()">
        </div>
        
        <div class="form-group">
          <label>Calculation Method</label>
          <input type="text" class="form-control" readonly
                 [value]="selectedScheme.calculationMethod">
        </div>
        
        <div class="form-group">
          <label>Interest Rate (%)</label>
          <input type="text" class="form-control" readonly
                 [value]="selectedScheme.roi">
        </div>
        
        <div class="form-group">
          <label>Processing Fee (%)</label>
          <input type="text" class="form-control" readonly
                 [value]="selectedScheme.processingFeePercent">
        </div>
      </div>

      <div class="calculation-summary">
        <div class="calc-row">
          <div class="calc-item">
            <label>Maximum Value:</label>
            <span class="amount">₹{{ totalMaximumValue | number:'1.0-0' }}</span>
          </div>
          <div class="calc-item">
            <label>Loan Amount:</label>
            <span class="amount primary">₹{{ loanAmount | number:'1.0-0' }}</span>
          </div>
        </div>
        
        <div class="calc-row">
          <div class="calc-item">
            <label>Interest ({{ loanForm.get('dueMonths')?.value || 12 }} months):</label>
            <span class="amount">₹{{ interestAmount | number:'1.0-0' }}</span>
          </div>
          <div class="calc-item">
            <label>Processing Fee:</label>
            <span class="amount">₹{{ processingFeeAmount | number:'1.0-0' }}</span>
          </div>
        </div>
        
        <div class="calc-row">
          <div class="calc-item">
            <label>Advance Interest ({{ loanForm.get('advanceMonths')?.value || 0 }} months):</label>
            <span class="amount">₹{{ advanceInterestAmount | number:'1.0-0' }}</span>
          </div>
          <div class="calc-item total">
            <label>Net Payable:</label>
            <span class="amount success">₹{{ netPayable | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-section form-actions">
      <div class="action-buttons">
        <button type="button" class="btn btn-secondary" (click)="onCancel()">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="deleteLoan()" *ngIf="isEditMode">
          <i class="fa fa-trash"></i> Delete
        </button>
        <button type="submit" class="btn btn-success" [disabled]="!loanForm.valid || isLoading">
          <i class="fa fa-save"></i>
          <span *ngIf="!isLoading">{{ isEditMode ? 'Update' : 'Save' }} Loan</span>
          <span *ngIf="isLoading">
            <i class="fa fa-spinner fa-spin"></i> Saving...
          </span>
        </button>
      </div>
    </div>
  </form>
</div>